# Autonomous Trading Company - Database Layer

Complete database foundation for the autonomous trading system with 6 AI agents.

## Overview

This database implements the Voxyz multi-agent system architecture adapted for trading:
- **15 SQL tables** following `ops_*` naming convention
- **JSONB for config** and flexible data storage
- **Proper indexes** for performance
- **Foreign keys with cascading deletes** for data integrity
- **Alembic-style migrations** for schema evolution
- **Seed scripts** for initial data
- **Helper functions** for common operations

## Database Schema

### Core Loop (4 tables)
1. `ops_trading_proposals` - Trading proposals from agents
2. `ops_missions` - Approved proposals become missions
3. `ops_mission_steps` - Individual steps within missions
4. `ops_agent_events` - Events generated by agents

### Policy & Config (3 tables)
5. `ops_policy` - System policies (auto-approval, limits, risk controls)
6. `ops_trigger_rules` - Reactive and proactive triggers
7. `ops_agent_reactions` - Queued agent-to-agent reactions

### Memory & Learning (3 tables)
8. `ops_agent_memory` - Agent memories (insights, patterns, strategies, lessons)
9. `ops_trade_outcomes` - Completed trade results
10. `ops_portfolio_history` - Historical portfolio snapshots

### Conversations (2 tables)
11. `ops_roundtable_queue` - Queued conversations between agents
12. `ops_agent_relationships` - Agent affinity scores and interactions

### Trading Specific (3 tables)
13. `ops_signals` - Trading signals from various sources
14. `ops_positions` - Open trading positions
15. `ops_action_runs` - System action runs for monitoring

## Setup Instructions

### 1. Prerequisites
- PostgreSQL 12+ with UUID extension
- Python 3.8+ (for helper functions)

### 2. Database Creation
```sql
CREATE DATABASE autonomous_trading;
CREATE USER atc_user WITH PASSWORD 'secure_password';
GRANT ALL PRIVILEGES ON DATABASE autonomous_trading TO atc_user;
```

### 3. Schema Deployment
```bash
# Apply the complete schema
psql -d autonomous_trading -f schema.sql

# Or apply migrations in order
psql -d autonomous_trading -f migrations/001_initial_schema.sql
```

### 4. Seed Data
```bash
# Apply all seed scripts in order
psql -d autonomous_trading -f seeds/01_initial_policies.sql
psql -d autonomous_trading -f seeds/02_trigger_rules.sql
psql -d autonomous_trading -f seeds/03_agent_relationships.sql
psql -d autonomous_trading -f seeds/04_agent_definitions.sql
```

### 5. Python Helper Setup
```bash
# Install dependencies (if needed)
pip install psycopg2-binary

# Test the helper functions
python db_utils.py
```

## Seed Data Details

### Initial Policies (7 keys)
1. `auto_approve` - Controls auto-approval vs roundtable requirements
2. `trade_limits` - Daily trading limits and position constraints
3. `risk_controls` - Risk management controls
4. `roundtable_policy` - Rules for conversations
5. `memory_influence_policy` - How memories influence decisions
6. `relationship_drift_policy` - How relationships evolve
7. `initiative_policy` - When agents can propose work

### Trigger Rules (12 triggers)
- **6 Reactive**: Respond to events (big wins, losses, risks, etc.)
- **6 Proactive**: Scheduled scans and reviews

### Agent Relationships (15 pairs)
- **High Affinity (4)**: Natural collaborators
- **Medium Affinity (6)**: Professional relationships
- **Low Affinity (5)**: Natural tension for healthy debate

### Agent Definitions (6 agents)
1. **ATLAS** - Strategy / Coordinator
2. **SAGE** - Risk Manager / Analyst
3. **SCOUT** - Execution / Market Monitor
4. **GROWTH** - Performance Analyst
5. **INTEL** - Research / Signal Scanner
6. **OBSERVER** - Quality Control / System Monitor

## Verification Commands

### Check All Tables
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name LIKE 'ops_%'
ORDER BY table_name;
```

### Verify Seed Data
```sql
-- Check policies
SELECT key, description FROM ops_policy ORDER BY key;

-- Check triggers
SELECT name, trigger_event, enabled FROM ops_trigger_rules ORDER BY name;

-- Check relationships
SELECT agent_a, agent_b, affinity FROM ops_agent_relationships ORDER BY affinity DESC;

-- Check agent definitions
SELECT key, value->>'name' as name, value->>'role' as role 
FROM ops_policy 
WHERE key LIKE 'agent_%' AND key != 'agent_list';
```

### Sample Queries

#### 1. Get Pending Proposals
```sql
SELECT id, agent_id, title, signal_type, created_at
FROM ops_trading_proposals
WHERE status = 'pending'
ORDER BY created_at DESC
LIMIT 10;
```

#### 2. Get Queued Steps by Kind
```sql
SELECT s.id, s.kind, m.title as mission_title, s.created_at
FROM ops_mission_steps s
JOIN ops_missions m ON s.mission_id = m.id
WHERE s.status = 'queued'
AND s.kind = 'execute_trade'
ORDER BY s.created_at ASC;
```

#### 3. Check Open Positions with P&L
```sql
SELECT token, entry_price, current_price, 
       unrealized_pnl, unrealized_pnl_percent,
       opened_at
FROM ops_positions
WHERE status = 'open'
ORDER BY unrealized_pnl_percent DESC;
```

#### 4. Get Recent Trade Outcomes
```sql
SELECT outcome_type, pnl_percent, 
       COUNT(*) as count,
       AVG(pnl_percent) as avg_pnl
FROM ops_trade_outcomes
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY outcome_type
ORDER BY outcome_type;
```

#### 5. Monitor System Health
```sql
SELECT action_type, status, 
       COUNT(*) as run_count,
       AVG(duration_ms) as avg_duration
FROM ops_action_runs
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY action_type, status
ORDER BY action_type, status;
```

#### 6. Get Agent Memories by Type
```sql
SELECT agent_id, type, 
       COUNT(*) as memory_count,
       AVG(confidence) as avg_confidence
FROM ops_agent_memory
WHERE promoted = true
GROUP BY agent_id, type
ORDER BY agent_id, type;
```

#### 7. Check Trigger Activity
```sql
SELECT name, fire_count, last_fired_at,
       CASE 
           WHEN last_fired_at IS NULL THEN 'Never fired'
           WHEN last_fired_at > NOW() - INTERVAL '1 hour' THEN 'Recent'
           ELSE 'Stale'
       END as status
FROM ops_trigger_rules
WHERE enabled = true
ORDER BY last_fired_at DESC NULLS LAST;
```

## Performance Tips

1. **Index Usage**: All common query patterns are indexed
2. **JSONB Indexing**: GIN indexes on array columns (tags)
3. **Partitioning Consider**: `ops_agent_events` and `ops_action_runs` could be partitioned by date
4. **Connection Pooling**: Use PgBouncer for production
5. **Regular Maintenance**: Run VACUUM ANALYZE weekly

## Migration Strategy

1. **Development**: Use `schema.sql` for initial setup
2. **Staging/Production**: Use numbered migration files
3. **Backwards Compatibility**: Always test migrations before applying
4. **Rollback Plan**: Keep previous schema.sql as backup

## Troubleshooting

### Common Issues

1. **UUID extension missing**:
   ```sql
   CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
   ```

2. **Permission errors**:
   ```sql
   GRANT ALL ON ALL TABLES IN SCHEMA public TO atc_user;
   GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO atc_user;
   ```

3. **Connection issues**:
   - Check PostgreSQL is running: `pg_isready`
   - Verify credentials in connection string
   - Check firewall rules

### Monitoring Queries

```sql
-- Check table sizes
SELECT table_name, 
       pg_size_pretty(pg_total_relation_size('"' || table_name || '"')) as size
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name LIKE 'ops_%'
ORDER BY pg_total_relation_size('"' || table_name || '"') DESC;

-- Check index usage
SELECT schemaname, tablename, indexname,
       idx_scan as index_scans,
       idx_tup_read as tuples_read,
       idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes
WHERE schemaname = 'public'
ORDER BY idx_scan DESC;
```

## Next Steps

1. **Integration**: Connect to application services
2. **Monitoring**: Set up pg_stat_statements for query analysis
3. **Backup**: Configure automated backups
4. **Replication**: Consider read replicas for reporting

## Files Created

- `schema.sql` - Complete database schema
- `migrations/001_initial_schema.sql` - Initial migration
- `seeds/01_initial_policies.sql` - 7 policy keys
- `seeds/02_trigger_rules.sql` - 12 triggers (6 reactive + 6 proactive)
- `seeds/03_agent_relationships.sql` - 15 agent pairs
- `seeds/04_agent_definitions.sql` - 6 agent definitions
- `db_utils.py` - Database helper functions
- `README.md` - This setup guide

## Support

For issues or questions:
1. Check the troubleshooting section
2. Review the ARCHITECTURE.md for context
3. Test with sample queries above

---

**Database Layer Complete** âœ…
Ready for integration with proposal service and trigger system.